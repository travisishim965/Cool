<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>99 Nights: Character View Simulator V12.9 (Escalation)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Monoton&display=swap');
        
        body {
            font-family: 'Courier New', monospace;
            background-color: #000000;
            color: #00ff00;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
            margin: 0;
        }
        #game-container {
            width: 90%;
            max-width: 900px;
            background-color: #0d0d0d;
            border: 4px solid #00ff00;
            padding: 20px;
            border-radius: 0;
            position: relative; 
            box-sizing: border-box;
        }
        h1 {
            color: #00ffff;
            text-align: center;
            text-shadow: 0 0 5px #00ff00;
        }
        
        /* --- PROGRESS BARS --- */
        .progress-bar {
            width: 100%;
            background-color: #333;
            border: 1px solid #00ff00;
            margin: 5px 0;
            height: 25px; 
            text-align: center;
            line-height: 25px;
            font-size: 1.1em;
            position: relative;
            margin-bottom: 15px;
        }
        
        #knowledge-bar, #hunger-bar {
             height: 15px; 
             line-height: 15px; 
             font-size: 0.8em;
             margin-bottom: 5px;
        }
        #knowledge-bar { border-color: #0099ff; }
        
        .progress-fill {
            height: 100%;
            position: absolute;
            left: 0;
            top: 0;
            transition: width 0.3s;
        }
        #hunger-bar .progress-fill { background-color: #ffa500; } 
        #health-bar .progress-fill { background-color: #ff0000; } 
        #knowledge-bar .progress-fill { background-color: #0099ff; }
        .progress-label {
            position: relative;
            z-index: 1;
            font-weight: bold;
        }

        /* --- CHARACTER DISPLAY AREA --- */
        #visual-scene {
            display: flex;
            justify-content: space-around;
            align-items: flex-start;
            margin-bottom: 20px;
            border: 2px solid #00ffff;
            padding: 15px;
            background-color: #050505;
        }
        
        .character-box {
            width: 45%;
            text-align: center;
            padding: 10px;
            border: 1px solid #00ff00;
            background-color: #1a1a1a;
            height: 250px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        #player-icon { 
            font-size: 80px;
            margin-bottom: 10px;
            height: 100px;
            line-height: 100px;
        }
        
        #threat-icon {
            font-family: 'Monoton', sans-serif;
            font-size: 24px; 
            color: #00ff99;
            text-shadow: 0 0 10px #00ff99;
            margin-bottom: 10px;
            height: 100px;
            line-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .threat-details {
            font-size: 1.1em;
            color: #ff88ff;
        }

        #log {
            height: auto; 
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #00ff00;
            padding: 8px;
            margin-bottom: 15px;
            width: 100%;
            box-sizing: border-box;
            background: #001100;
        }
        
        #actions {
            width: 100%;
            text-align: center;
        }
        
        #actions button {
            padding: 10px 15px;
            margin: 5px;
            font-size: 1em;
            cursor: pointer;
            background-color: #004400;
            color: #00ff00;
            border: 1px solid #00ff00;
            border-radius: 0;
            width: 180px;
        }
        #actions button:hover {
            background-color: #006600;
        }
        #action-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            padding: 10px 0;
        }
        
        /* --- FIGHT SCREEN OVERLAY --- */
        #fight-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            color: #ffff00;
            display: none; 
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            padding: 20px;
            box-sizing: border-box;
        }
        #fight-log {
            height: 150px;
            width: 90%;
            overflow-y: auto;
            border: 1px solid #ff00ff;
            padding: 10px;
            margin-bottom: 20px;
            background-color: #1a001a;
        }
        #fight-stats {
            display: flex;
            justify-content: space-around;
            width: 90%;
            margin-bottom: 30px;
        }
        #fight-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #fight-controls button {
            background-color: #990099;
            color: #ffff00;
            border-color: #ff00ff;
            width: 150px;
            margin: 10px;
        }
        .fight-bar-container {
            width: 45%;
            text-align: center;
        }
        .fight-bar {
            width: 100%;
            background-color: #333;
            border: 1px solid #ff0000;
            margin: 5px 0;
            height: 15px;
            position: relative;
        }
        .fight-fill {
            height: 100%;
            position: absolute;
            left: 0;
            top: 0;
            transition: width 0.3s;
        }
        #fight-player-bar .fight-fill { background-color: #00ff00; }
        #fight-threat-bar .fight-fill { background-color: #ff0000; }

        /* --- GLOBAL OVERLAYS (TUTORIALS & END SCREENS) --- */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.99);
            color: #00ffff;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
            padding: 20px;
            text-align: center;
            box-sizing: border-box;
        }
        .overlay h2 { color: #ffff00; margin-bottom: 20px; }
        .overlay button {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #004444;
            color: #00ffff;
            border: 1px solid #00ffff;
            cursor: pointer;
        }
        
        /* Specific Ending Styles */
        #game-over-screen h2 { color: #ff0000; font-size: 3em; }
        #victory-screen h2 { color: #00ff00; font-size: 3em; }

        .message-success { color: #00ff00; }
        .message-fail { color: #ff0000; }
        .message-event { color: #ffff00; }
        .message-critical { color: #ff0000; font-weight: bold; }
        .message-hint { color: #00ffff; font-style: italic;}
    </style>
</head>
<body>

    <div id="game-container">
        <h1>[99Nights] SIMULATOR V12.9</h1>
        <p style="text-align: center; color: #00ffff;">Action Points: <span id="ap-stat">0</span> | Night: <span id="night-counter">1</span> / 99</p>

        <div id="visual-scene">
            <div id="player-view" class="character-box">
                <div id="player-icon">ðŸ‘¤</div> 
                <h3 id="player-name-display">Awaiting Initialization...</h3> 
                <p>Equipped: Gear (<span id="durability-stat-icon">100</span>%)</p>
            </div>
            <div id="threat-view" class="character-box">
                <div id="threat-icon">TEAM BRAINROT</div> 
                <h3 id="threat-name-display">Awaiting Encounter...</h3>
                <p class="threat-details" id="threat-state-display">---</p>
            </div>
        </div>
        <div id="health-bar" class="progress-bar">
            <div id="health-fill" class="progress-fill"></div>
            <span id="health-label" class="progress-label">HEALTH: 100%</span>
        </div>
        
        <div id="knowledge-bar" class="progress-bar">
            <div id="knowledge-fill" class="progress-fill"></div>
            <span id="knowledge-label" class="progress-label">KNOWLEDGE: 0 / 500</span>
        </div>

        <div id="hunger-bar" class="progress-bar">
            <div id="hunger-fill" class="progress-fill"></div>
            <span id="hunger-label" class="progress-label">HUNGER: 100%</span>
        </div>
        
        <div id="log">
            <p class="message-event">System Initialized. Click START to generate your Brainrot identity.</p>
        </div>

        <div id="actions">
            <button id="startButton" onclick="startGame()">START ENCOUNTER</button>
            <div id="action-buttons" style="display: none;"></div>
        </div>
        
        <div id="fight-screen">
            <h2>ðŸ§  BRAINROT COMBAT ENGAGED ðŸ§ </h2>
            <div id="fight-stats">
                <div class="fight-bar-container">
                    Player HP: <span id="fight-player-hp">100</span>%
                    <div id="fight-player-bar" class="fight-bar"><div id="fight-player-fill" class="fight-fill"></div></div>
                </div>
                <div class="fight-bar-container">
                    Brainrot HP: <span id="fight-threat-hp">100</span>%
                    <div id="fight-threat-bar" class="fight-bar"><div id="fight-threat-fill" class="fight-fill"></div></div>
                </div>
            </div>
            <div id="fight-log">
                <p>The **<span id="fight-threat-name"></span>** lunges!</p>
            </div>
            <div id="fight-controls">
                <p id="fight-prompt">---</p>
                <div style="display: flex;">
                    <button onclick="fightAction('PUNCH')">PUNCH ðŸ‘Š</button>
                    <button onclick="fightAction('DODGE')">DODGE ðŸ¤¸</button>
                </div>
            </div>
        </div>
        
        <div id="pregame-tutorial" class="overlay">
            <h2>START-UP TUTORIAL</h2>
            <div id="tutorial-step-text">Would you like a brief, interactive tutorial?</div>
            <div id="tutorial-actions">
                <button onclick="startTutorial()">YES, GUIDE ME</button>
                <button onclick="skipTutorial()">NO, START GAME</button>
            </div>
        </div>
        
        <div id="combat-tutorial" class="overlay" style="display: none;">
            <h2>COMBAT TUTORIAL: THE BRAINROT CYCLE</h2>
            <p>1. **IF IT PUNCHES:** You must choose **DODGE**.</p>
            <p>2. **IF IT DODGES:** You must choose **PUNCH**.</p>
            <button onclick="exitCombatTutorial()">RESUME FIGHT</button>
        </div>

        <div id="game-over-screen" class="overlay">
            <h2>TERMINATED</h2>
            <p id="death-reason" style="font-size: 1.5em; color: white;"></p>
            <button onclick="location.reload()" style="background-color: #550000; border-color: red;">REDEPLOY</button>
        </div>

        <div id="victory-screen" class="overlay">
            <h2>MISSION ACCOMPLISHED</h2>
            <p style="font-size: 1.5em; color: white;">The 99th Night has passed. Rescue has arrived.</p>
            <button onclick="location.reload()" style="background-color: #005500; border-color: lime;">PLAY AGAIN</button>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const NIGHTS_TO_SURVIVE = 99;
        const GEAR_DRAIN_PER_NIGHT = 5;
        const HUNGER_DRAIN_PER_NIGHT = 10;
        const MAX_KNOWLEDGE = 500; 
        
        const STUDY_KNOWLEDGE_GAIN = 10; 
        const FIGHT_AP_REWARD = 1; 
        const HEALTH_ESCALATION_MULTIPLIER = 1.5; // Multiplier
        const FORCE_COMBAT_AFTER_NIGHTS = 4; // Forces fight on night 4
        
        const ANIMAL_PARTS_MAP = {
            'Cat': 'ðŸˆ', 'Dog': 'ðŸ•', 'Capybara': 'ðŸ¦¦', 
            'Nutria': 'ðŸ¦«', 'Seagull': 'âš¡', 'Rabbit': 'ðŸ‡', 
            'Fox': 'ðŸ¦Š', 'Otter': 'ðŸ¦¦'
        };
        const ANIMAL_NAMES = Object.keys(ANIMAL_PARTS_MAP);

        // --- THREAT DATA ---
        const THREAT_DATA = [
            { name: "tralalero Tralala", state: { ideal_action: "Fight", non_ideal: "Escape" } },
            { name: "Travcitos", state: { ideal_action: "Escape", non_ideal: "Fight" } },
            { name: "tung tung tung sahur", state: { ideal_action: "Eat", non_ideal: "Study" } },
            { name: "Ballerina Cappucina", state: { ideal_action: "Study", non_ideal: "Eat" } },
            { name: "Brr Brr Patapim", state: { ideal_action: "Fight", non_ideal: "Eat" } },
            { name: "Lirili Larila", state: { ideal_action: "Escape", non_ideal: "Study" } },
            { name: "Odin Din Din Dun", state: { ideal_action: "Study", non_ideal: "Fight" } },
            { name: "Dragon Canneloni", state: { ideal_action: "Eat", non_ideal: "Escape" } },
        ];
        
        // --- ACTION DEFINITIONS ---
        const ACTION_MATRIX = {
            "Fight": { ap_cost: 0, desc: "Enter combat.", type: "combat" }, 
            "Escape": { ap_cost: 1, h: -10, d: -5, type: "utility" }, 
            "Eat": { ap_cost: 1, h: 0, hng_gain: 40, type: "utility" }, 
            "Study": { ap_cost: 1, h: -5, k_gain: STUDY_KNOWLEDGE_GAIN, type: "utility" }, 
            "Maintain Gear": { ap_cost: 1, h: -10, d_gain: 50, type: "utility" }
        };

        // --- GAME STATE ---
        let gameState = {
            night: 0,
            health: 100, durability: 100, hunger: 100,
            actionPoints: 0, 
            knowledge: 0, 
            activeThreats: [], 
            playerName: "Awaiting Generation",
            playerIcon: "ðŸ‘¤",
            isRunning: false,
            tutorialStep: 0, 
            fightState: {
                inProgress: false,
                threatHP: 100, 
                playerHP: 100,
                threatNextMove: null, 
                targetThreatIndex: -1,
            }
        };

        // --- DOM REFERENCES ---
        let D = {};

        // --- UTILITY ---
        function clamp(value) { return Math.max(0, Math.min(100, value)); }
        function clampHunger(value) { return Math.max(0, Math.min(100, value)); } 
        
        function appendLog(message, className = 'message-event') {
            if (!D.logDiv) return;
            const p = document.createElement('p');
            p.className = className;
            const prefix = gameState.tutorialStep > 0 ? "[TUTORIAL]" : `[NIGHT ${gameState.night}]`;
            p.innerHTML = `${prefix} ${message}`;
            D.logDiv.appendChild(p);
            D.logDiv.scrollTop = D.logDiv.scrollHeight; 
        }

        function generateAnimalCombosName() {
            let part1 = ANIMAL_NAMES[Math.floor(Math.random() * ANIMAL_NAMES.length)];
            let part2 = ANIMAL_NAMES[Math.floor(Math.random() * ANIMAL_NAMES.length)];
            while (part1 === part2) {
                part2 = ANIMAL_NAMES[Math.floor(Math.random() * ANIMAL_NAMES.length)];
            }
            const iconKey = Math.random() < 0.5 ? part1 : part2;
            gameState.playerIcon = ANIMAL_PARTS_MAP[iconKey];
            return `${part1}-${part2}`;
        }
        
        // --- STAT AND DISPLAY UPDATE FUNCTIONS ---
        function updateStatsDisplay() {
            if (!D.nightCounter) return;
            
            const knowledge = gameState.knowledge;
            const knowledgePercent = (knowledge / MAX_KNOWLEDGE) * 100;

            D.playerNameDisplay.textContent = gameState.playerName.toUpperCase();
            D.playerIcon.textContent = gameState.playerIcon; 
            D.nightCounter.textContent = gameState.night;
            D.durabilityStatIcon.textContent = clamp(gameState.durability);
            D.apStat.textContent = gameState.actionPoints;
            
            D.healthFill.style.width = `${clamp(gameState.health)}%`;
            D.healthLabel.textContent = `HEALTH: ${gameState.health.toFixed(0)}%`;
            
            D.knowledgeFill.style.width = `${clamp(knowledgePercent)}%`;
            D.knowledgeLabel.textContent = `KNOWLEDGE: ${knowledge} / ${MAX_KNOWLEDGE}`;
            
            D.hungerFill.style.width = `${clamp(gameState.hunger)}%`;
            D.hungerLabel.textContent = `HUNGER: ${gameState.hunger.toFixed(0)}%`;
            
            if (gameState.activeThreats.length > 0) {
                const oldestThreat = gameState.activeThreats[0];
                D.threatNameDisplay.textContent = oldestThreat.name.toUpperCase();
                D.threatStateDisplay.textContent = `Threats Active: ${gameState.activeThreats.length}`;
            } else {
                 D.threatNameDisplay.textContent = 'NO ACTIVE THREATS';
                 D.threatStateDisplay.textContent = `AP: ${gameState.actionPoints}`;
            }
        }
        
        // --- GAME LOOP INITIATORS ---
        function initializeDOMElements() {
            D.gameContainer = document.getElementById('game-container');
            D.nightCounter = document.getElementById('night-counter');
            D.durabilityStatIcon = document.getElementById('durability-stat-icon');
            D.apStat = document.getElementById('ap-stat');
            D.healthFill = document.getElementById('health-fill');
            D.healthLabel = document.getElementById('health-label');
            D.knowledgeFill = document.getElementById('knowledge-fill');
            D.knowledgeLabel = document.getElementById('knowledge-label');
            D.hungerFill = document.getElementById('hunger-fill');
            D.hungerLabel = document.getElementById('hunger-label');
            D.logDiv = document.getElementById('log');
            D.startButton = document.getElementById('startButton');
            D.actionButtonsDiv = document.getElementById('action-buttons');
            D.playerIcon = document.getElementById('player-icon');
            D.playerNameDisplay = document.getElementById('player-name-display');
            D.threatNameDisplay = document.getElementById('threat-name-display');
            D.threatStateDisplay = document.getElementById('threat-state-display');
            D.threatView = document.getElementById('threat-view');
            D.pregameTutorial = document.getElementById('pregame-tutorial');
        }

        window.startGame = function() {
            if (gameState.isRunning) return;
            initializeDOMElements(); 
            const generatedName = generateAnimalCombosName();

            gameState = {
                night: 0,
                health: 100, durability: 100, hunger: 100,
                actionPoints: 0, 
                knowledge: 0, 
                activeThreats: [], 
                playerName: generatedName,
                playerIcon: gameState.playerIcon,
                isRunning: true,
                fightState: { inProgress: false, threatHP: 100, playerHP: 100 }
            };

            D.pregameTutorial.style.display = 'flex';
        }

        function createActionButton(actionName) {
            const button = document.createElement('button');
            const action = ACTION_MATRIX[actionName];
            button.textContent = `${actionName.toUpperCase()} (-${action.ap_cost} AP)`;
            button.onclick = () => window.takeAction(actionName); 
            D.actionButtonsDiv.appendChild(button);
        }

        function initializeGameUI() {
            D.startButton.style.display = 'none';
            D.actionButtonsDiv.style.display = 'flex';
            D.logDiv.innerHTML = '';
            D.actionButtonsDiv.innerHTML = '';
            Object.keys(ACTION_MATRIX).forEach(createActionButton);
            appendLog(`Welcome, ${gameState.playerName}!`, 'message-success');
            window.advanceNight(); 
        }

        // --- CORE GAME LOOP ---
        window.advanceNight = function() {
            if (!gameState.isRunning && gameState.night > 0) return;

            gameState.night++;
            
            if (gameState.night > NIGHTS_TO_SURVIVE) {
                endGame(true, "Victory");
                return;
            }

            // Stat Drains
            if (gameState.night > 1) {
                gameState.durability = clamp(gameState.durability - GEAR_DRAIN_PER_NIGHT);
                gameState.hunger = clampHunger(gameState.hunger - HUNGER_DRAIN_PER_NIGHT);

                if (gameState.hunger <= 20) {
                    gameState.health = clamp(gameState.health - 5);
                    appendLog(`Hunger Damage!`, 'message-critical');
                }
            }
            
            if (gameState.health <= 0) {
                endGame(false, "Your health dropped to zero.");
                return;
            }

            // --- 1. MANDATORY SPAWN (Done first) ---
            const newThreatData = THREAT_DATA[Math.floor(Math.random() * THREAT_DATA.length)];
            const newThreat = {
                ...newThreatData,
                baseHP: 100, 
                daysPersistent: 1, // Start on Day 1
            };
            gameState.activeThreats.push(newThreat);
            appendLog(`New Brainrot: **${newThreat.name}**!`, 'message-event');

            // --- 2. CHECK PERSISTENCE (Escalation) ---
            let forcedFightIndex = -1;
            
            // Loop through all existing threats (EXCEPT the one we just spawned)
            gameState.activeThreats.forEach((threat, index) => {
                if (threat === newThreat) return; // Skip new spawn

                threat.daysPersistent += 1;
                
                // 1.5x Multiplier for persisting
                const oldHP = threat.baseHP;
                threat.baseHP = Math.floor(threat.baseHP * HEALTH_ESCALATION_MULTIPLIER);
                
                if (index === 0) { // Notify player about the active threat getting buffed
                    appendLog(`Brainrot grew stronger! HP: ${oldHP} -> ${threat.baseHP}`, 'message-critical');
                }

                // Force Fight if Day 4 reached
                if (threat.daysPersistent >= FORCE_COMBAT_AFTER_NIGHTS) {
                    forcedFightIndex = index;
                }
            });

            // --- 3. TRIGGER FORCED FIGHT IF NEEDED ---
            if (forcedFightIndex !== -1) {
                appendLog("IGNORED TOO LONG! COMBAT FORCED!", 'message-critical');
                enterFightScreen(forcedFightIndex);
                return; // Stop processing, go to fight
            }

            gameState.actionPoints = 1; // 1 AP PER NIGHT
            updateStatsDisplay();
        }

        // --- ACTION HANDLERS ---
        window.takeAction = function(actionName) {
            if (!gameState.isRunning || gameState.fightState.inProgress) return;
            const action = ACTION_MATRIX[actionName];
            
            if (action.ap_cost > 0 && gameState.actionPoints < action.ap_cost) {
                appendLog(`Not enough Action Points.`, 'message-fail');
                return;
            }

            if (actionName === "Fight") {
                if (gameState.activeThreats.length === 0) return;
                enterFightScreen(0); 
                return;
            }

            if (action.ap_cost > 0) gameState.actionPoints -= action.ap_cost;

            gameState.health = clamp(gameState.health + (action.h || 0));
            gameState.durability = clamp(gameState.durability + (action.d_gain || 0) + (action.d || 0));
            gameState.hunger = clampHunger(gameState.hunger + (action.hng_gain || 0));

            let message = `You chose to **${actionName}**.`;
            let successClass = 'message-event';

            if (actionName === "Study") {
                const kGain = 10;
                gameState.knowledge = Math.min(gameState.knowledge + kGain, MAX_KNOWLEDGE);
                message += ` Gained KNOWLEDGE.`;
                successClass = 'message-success';
            } 
            
            if (actionName === "Escape") {
                if (gameState.activeThreats.length > 0) {
                    const escapedThreat = gameState.activeThreats.shift();
                    message = `ESCAPED **${escapedThreat.name}**! Health reduced by 10%.`;
                    successClass = 'message-hint';
                }
            }

            appendLog(message, successClass);
            
            if (gameState.actionPoints <= 0) {
                appendLog("Resting...", 'message-event');
                setTimeout(window.advanceNight, 1000); 
            }
            updateStatsDisplay();
        }


        // --- COMBAT FUNCTIONS ---
        function enterFightScreen(targetIndex) {
            const targetThreat = gameState.activeThreats[targetIndex];
            if (!targetThreat) return;
            gameState.fightState.inProgress = true;
            gameState.fightState.targetThreatIndex = targetIndex;
            gameState.fightState.playerHP = 100;
            gameState.fightState.threatHP = targetThreat.baseHP;

            document.getElementById('fight-screen').style.display = 'flex';
            document.getElementById('fight-threat-name').textContent = targetThreat.name.toUpperCase();
            document.getElementById('fight-log').innerHTML = '';
            
            setTimeout(promptNextFightMove, 500);
        }

        function promptNextFightMove() {
            if (!gameState.fightState.inProgress) return;
            const threatAction = Math.random() < 0.25 ? 'PUNCH' : 'DODGE';
            gameState.fightState.threatNextMove = threatAction;
            document.getElementById('fight-prompt').textContent = "Counter? (PUNCH or DODGE)";
        }

        function fightLog(message, className = '') {
            const logDiv = document.getElementById('fight-log');
            const p = document.createElement('p');
            p.className = className;
            p.innerHTML = message;
            logDiv.appendChild(p);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        window.fightAction = function(playerAction) {
            if (!gameState.fightState.inProgress) return;
            const targetThreat = gameState.activeThreats[gameState.fightState.targetThreatIndex];
            const threatAction = gameState.fightState.threatNextMove;
            let playerDamage = 0;
            let threatDamage = 0;

            if (playerAction === 'PUNCH') {
                if (threatAction === 'DODGE') {
                    // NEW 80% DODGE LOGIC
                    if (Math.random() < 0.8) {
                        threatDamage = 0; // Evaded completely
                        fightLog(`The Brainrot dodged smoothly! (Miss)`, 'message-fail');
                    } else {
                        threatDamage = 15; // Failed dodge
                        fightLog(`It tried to dodge but stumbled!`, 'message-success');
                    }
                } else { 
                    // Clash
                    playerDamage = 20 + Math.random() * 10; 
                    fightLog(`Clash! You took heavy damage!`, 'message-fail');
                }
            } else { 
                if (threatAction === 'PUNCH') {
                    fightLog(`Perfect Dodge!`, 'message-success');
                } else { 
                    playerDamage = 5; 
                    fightLog(`Stalemate. Minor fatigue.`, 'message-fail');
                }
            }

            gameState.fightState.playerHP -= playerDamage;
            gameState.fightState.threatHP -= threatDamage;

            document.getElementById('fight-player-fill').style.width = `${clamp(gameState.fightState.playerHP)}%`;
            document.getElementById('fight-player-hp').textContent = gameState.fightState.playerHP.toFixed(0);
            
            const currentThreatHPRatio = (gameState.fightState.threatHP / targetThreat.baseHP) * 100;
            document.getElementById('fight-threat-fill').style.width = `${clamp(currentThreatHPRatio)}%`;
            document.getElementById('fight-threat-hp').textContent = clamp(currentThreatHPRatio).toFixed(0);

            if (gameState.fightState.playerHP <= 0) {
                fightLog(`Defeated!`, 'message-critical');
                exitFightScreen(false);
            } else if (gameState.fightState.threatHP <= 0) {
                fightLog(`Victory!`, 'message-success');
                exitFightScreen(true);
            } else {
                setTimeout(promptNextFightMove, 1000);
            }
        }

        function exitFightScreen(victory) {
            document.getElementById('fight-screen').style.display = 'none';
            gameState.fightState.inProgress = false;
            
            const finalHealthPercentage = gameState.fightState.playerHP;
            gameState.health = clamp(gameState.health * (finalHealthPercentage / 100));

            const targetIndex = gameState.fightState.targetThreatIndex;
            if (victory) {
                gameState.activeThreats.splice(targetIndex, 1);
                gameState.actionPoints += FIGHT_AP_REWARD;
                appendLog(`Combat Victory! +1 AP.`, 'message-success');
            } else {
                appendLog(`Combat Defeat.`, 'message-critical');
                if (gameState.health <= 0) {
                    endGame(false, "Killed in combat.");
                    return;
                }
            }
            if (gameState.actionPoints <= 0) {
                 setTimeout(window.advanceNight, 1000); 
            }
            updateStatsDisplay();
        }

        function endGame(win, reason = "") {
            gameState.isRunning = false;
            
            if (win) {
                document.getElementById('victory-screen').style.display = 'flex';
            } else {
                document.getElementById('death-reason').textContent = reason;
                document.getElementById('game-over-screen').style.display = 'flex';
            }
            
            D.actionButtonsDiv.style.display = 'none';
        }

        // --- TUTORIAL FUNCTIONS ---
        function startTutorial() {
            D.pregameTutorial.style.display = 'flex';
            gameState.tutorialStep = 1;
            window.runTutorialStep(1); 
        }

        function skipTutorial() {
            D.pregameTutorial.style.display = 'none';
            initializeGameUI();
        }

        window.runTutorialStep = function(step) { 
            gameState.tutorialStep = step;
            const stepText = document.getElementById('tutorial-step-text');
            const actionsDiv = document.getElementById('tutorial-actions');
            actionsDiv.innerHTML = '';
            
            switch(gameState.tutorialStep) {
                case 1:
                    stepText.innerHTML = `<h2>1. Core Loop</h2><p>Survive 99 Nights. You get 1 AP per night.</p>`;
                    actionsDiv.innerHTML = `<button onclick="runTutorialStep(2)">NEXT</button>`;
                    break;
                case 2:
                    stepText.innerHTML = `<h2>2. Brainrots</h2><p>A new Brainrot appears every night.</p>`;
                    actionsDiv.innerHTML = `<button onclick="runTutorialStep(3)">START GAME</button>`;
                    break;
                case 3:
                    gameState.tutorialStep = 0; 
                    D.pregameTutorial.style.display = 'none';
                    initializeGameUI();
                    break;
            }
        }
        
        document.addEventListener('DOMContentLoaded', initializeDOMElements);
    </script>
</body>
</html>
